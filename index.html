<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>GrapesJS</title>
    <link rel="stylesheet" href="dist/css/grapes.min.css">
    <script src="grapes.min.js"></script>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
      }
    </style>
  </head>

  <body>
    <div id="gjs" style="height:0px; overflow:hidden;">
      <style> 
      </style>
    </div>

    <script src="node_modules/grapesjs-blocks-basic/dist/index.js"></script>
    <script src="node_modules/grapesjs-echarts-fix/dist/grapesjs-echarts.min.js"></script>

    <script type="text/javascript">

      async function fetchData() {
        try {
          const xmlData = await grapesjs.xmlData.getXMLData();
          return xmlData;
        } catch (error) {
          console.error('Error:', error);
        }
      }

      //prendo i dati dall'xml della fattura
      fetchData().then((xmlDoc) => {
        console.log(xmlDoc);

        const editor = grapesjs.init({
          showOffsets: 1,
          noticeOnUnload: 0,
          container: '#gjs',
          height: '100%',
          fromElement: true,
          plugins: ["gjs-blocks-basic", "grapesjs-echarts-fix"],
          pluginsOpts: {
            "gjs-blocks-basic": {
              /* ...options */
            },
            "grapesjs-echarts-fix": {
              /* options */
            },
          },
          storageManager: { autoload: 0 },
          styleManager : {
            sectors: [{
                name: 'General',
                open: false,
                buildProps: ['float', 'display', 'position', 'top', 'right', 'left', 'bottom']
              },{
                name: 'Flex',
                open: false,
                buildProps: ['flex-direction', 'flex-wrap', 'justify-content', 'align-items', 'align-content', 'order', 'flex-basis', 'flex-grow', 'flex-shrink', 'align-self']
              },{
                name: 'Dimension',
                open: false,
                buildProps: ['width', 'height', 'max-width', 'min-height', 'margin', 'padding'],
              },{
                name: 'Typography',
                open: false,
                buildProps: ['font-family', 'font-size', 'font-weight', 'letter-spacing', 'color', 'line-height', 'text-shadow'],
              },{
                name: 'Decorations',
                open: false,
                buildProps: ['border-radius-c', 'background-color', 'border-radius', 'border', 'box-shadow', 'background'],
              },{
                name: 'Extra',
                open: false,
                buildProps: ['transition', 'perspective', 'transform'],
              }
            ],
          }
        });

        if (xmlDoc) {
          const numeroFattura = xmlDoc.querySelector("NumeroFattura").textContent;
          const idDocumento = xmlDoc.querySelector("IdDocumento").textContent;
          const dataEmissione = xmlDoc.querySelector("DataEmissione").textContent;
          const tipoDocumento = xmlDoc.querySelector("TipoDocumento").textContent;

          editor.BlockManager.add('xmlBlock', {
            label: 'Dati Fattura',
            attributes: { class: 'gjs-fonts gjs-f-b1' },
            content: `
              <div>
                <p>Numero Fattura: ${numeroFattura}</p>
                <p>Id Documento: ${idDocumento}</p>
                <p>Data Emissione: ${dataEmissione}</p>
                <p>Tipo Documento: ${tipoDocumento}</p>
              </div>
            `
          });

          // Aggiungi ulteriori elementi come FatturaConsumiStimati
          const fatturaConsumiStimati = xmlDoc.querySelectorAll("FatturaConsumiStimati > RigaConsumiStimati");
          
          fatturaConsumiStimati.forEach(consumo => {
            const idSito = consumo.getAttribute("IdSito");
            const mese = consumo.getAttribute("Mese");
            const anno = consumo.getAttribute("Anno");
            const valore = consumo.textContent;
            
            editor.BlockManager.add('consumiStimatiBlock', {
              label: 'Consumi Stimati',
              attributes: { class: 'gjs-fonts gjs-f-b1' },
              content: `
                <div>
                  <p>Id Sito: ${idSito}</p>
                  <p>Mese: ${mese}</p>
                  <p>Anno: ${anno}</p>
                  <p>Valore: ${valore}</p>
                </div>
              `
            });
          });
        }

      });  

    </script>
  </body>
</html>
